<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StudentController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Student Service</a> &gt; <a href="index.source.html" class="el_package">com.school.sms.student.presentation.controller</a> &gt; <span class="el_source">StudentController.java</span></div><h1>StudentController.java</h1><pre class="source lang-java linenums">package com.school.sms.student.presentation.controller;

import com.school.sms.student.application.dto.StudentDTO;
import com.school.sms.student.application.service.StudentManagementService;
import com.school.sms.student.application.service.StudentRegistrationService;
import com.school.sms.student.application.service.StudentSearchService;
import com.school.sms.student.application.service.StudentStatusService;
import com.school.sms.student.domain.valueobject.StudentStatus;
import com.school.sms.student.presentation.dto.CreateStudentRequest;
import com.school.sms.student.presentation.dto.StudentPageResponse;
import com.school.sms.student.presentation.dto.UpdateStatusRequest;
import com.school.sms.student.presentation.dto.UpdateStudentRequest;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.media.Content;
import io.swagger.v3.oas.annotations.media.Schema;
import io.swagger.v3.oas.annotations.responses.ApiResponse;
import io.swagger.v3.oas.annotations.responses.ApiResponses;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.http.HttpStatus;
import org.springframework.http.ProblemDetail;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

/**
 * REST controller for Student operations.
 * Provides CRUD endpoints for student management.
 */
@RestController
@RequestMapping(&quot;/students&quot;)
<span class="fc" id="L38">@RequiredArgsConstructor</span>
<span class="fc" id="L39">@Slf4j</span>
@Tag(name = &quot;Student Management&quot;, description = &quot;APIs for managing student records&quot;)
public class StudentController {

    private final StudentRegistrationService registrationService;
    private final StudentManagementService managementService;
    private final StudentSearchService searchService;
    private final StudentStatusService statusService;

    /**
     * Creates a new student.
     *
     * @param request the create student request
     * @param userId the user ID from header
     * @return created student DTO
     */
    @PostMapping
    @Operation(summary = &quot;Create a new student&quot;, description = &quot;Register a new student with validation&quot;)
    @ApiResponses(value = {
            @ApiResponse(responseCode = &quot;201&quot;, description = &quot;Student created successfully&quot;,
                    content = @Content(schema = @Schema(implementation = StudentDTO.class))),
            @ApiResponse(responseCode = &quot;400&quot;, description = &quot;Invalid input or age validation failed&quot;,
                    content = @Content(schema = @Schema(implementation = ProblemDetail.class))),
            @ApiResponse(responseCode = &quot;409&quot;, description = &quot;Duplicate mobile number&quot;,
                    content = @Content(schema = @Schema(implementation = ProblemDetail.class)))
    })
    public ResponseEntity&lt;StudentDTO&gt; createStudent(
            @Valid @RequestBody CreateStudentRequest request,
            @RequestHeader(value = &quot;X-User-ID&quot;, defaultValue = &quot;SYSTEM&quot;) String userId) {

<span class="nc" id="L69">        log.info(&quot;Creating student: {} {}&quot;, request.getFirstName(), request.getLastName());</span>
<span class="nc" id="L70">        StudentDTO student = registrationService.registerStudent(request, userId);</span>
<span class="nc" id="L71">        return ResponseEntity.status(HttpStatus.CREATED).body(student);</span>
    }

    /**
     * Gets a student by ID.
     *
     * @param studentId the student ID
     * @return student DTO
     */
    @GetMapping(&quot;/{studentId}&quot;)
    @Operation(summary = &quot;Get student by ID&quot;, description = &quot;Retrieve student details by student ID&quot;)
    @ApiResponses(value = {
            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Student found&quot;,
                    content = @Content(schema = @Schema(implementation = StudentDTO.class))),
            @ApiResponse(responseCode = &quot;404&quot;, description = &quot;Student not found&quot;,
                    content = @Content(schema = @Schema(implementation = ProblemDetail.class)))
    })
    public ResponseEntity&lt;StudentDTO&gt; getStudent(
            @Parameter(description = &quot;Student ID (e.g., STU-2025-00001)&quot;)
            @PathVariable String studentId) {

<span class="nc" id="L92">        log.info(&quot;Getting student: {}&quot;, studentId);</span>
<span class="nc" id="L93">        StudentDTO student = searchService.findById(studentId);</span>
<span class="nc" id="L94">        return ResponseEntity.ok(student);</span>
    }

    /**
     * Updates a student.
     *
     * @param studentId the student ID
     * @param request the update request
     * @param userId the user ID from header
     * @return updated student DTO
     */
    @PutMapping(&quot;/{studentId}&quot;)
    @Operation(summary = &quot;Update student&quot;, description = &quot;Update student profile with optimistic locking&quot;)
    @ApiResponses(value = {
            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Student updated successfully&quot;,
                    content = @Content(schema = @Schema(implementation = StudentDTO.class))),
            @ApiResponse(responseCode = &quot;400&quot;, description = &quot;Invalid input&quot;,
                    content = @Content(schema = @Schema(implementation = ProblemDetail.class))),
            @ApiResponse(responseCode = &quot;404&quot;, description = &quot;Student not found&quot;,
                    content = @Content(schema = @Schema(implementation = ProblemDetail.class))),
            @ApiResponse(responseCode = &quot;409&quot;, description = &quot;Concurrent update or duplicate mobile&quot;,
                    content = @Content(schema = @Schema(implementation = ProblemDetail.class)))
    })
    public ResponseEntity&lt;StudentDTO&gt; updateStudent(
            @Parameter(description = &quot;Student ID&quot;)
            @PathVariable String studentId,
            @Valid @RequestBody UpdateStudentRequest request,
            @RequestHeader(value = &quot;X-User-ID&quot;, defaultValue = &quot;SYSTEM&quot;) String userId) {

<span class="nc" id="L123">        log.info(&quot;Updating student: {}&quot;, studentId);</span>
<span class="nc" id="L124">        StudentDTO student = managementService.updateStudent(studentId, request, userId);</span>
<span class="nc" id="L125">        return ResponseEntity.ok(student);</span>
    }

    /**
     * Deletes a student (soft delete).
     *
     * @param studentId the student ID
     */
    @DeleteMapping(&quot;/{studentId}&quot;)
    @Operation(summary = &quot;Delete student&quot;, description = &quot;Soft delete a student (sets status to INACTIVE)&quot;)
    @ApiResponses(value = {
            @ApiResponse(responseCode = &quot;204&quot;, description = &quot;Student deleted successfully&quot;),
            @ApiResponse(responseCode = &quot;404&quot;, description = &quot;Student not found&quot;,
                    content = @Content(schema = @Schema(implementation = ProblemDetail.class)))
    })
    public ResponseEntity&lt;Void&gt; deleteStudent(
            @Parameter(description = &quot;Student ID&quot;)
            @PathVariable String studentId) {

<span class="nc" id="L144">        log.info(&quot;Deleting student: {}&quot;, studentId);</span>
<span class="nc" id="L145">        managementService.deleteStudent(studentId);</span>
<span class="nc" id="L146">        return ResponseEntity.noContent().build();</span>
    }

    /**
     * Searches students with filters and pagination.
     *
     * @param status student status filter
     * @param lastName last name filter (starts with)
     * @param page page number (0-indexed)
     * @param size page size
     * @param sort sort field and direction
     * @return paginated student list
     */
    @GetMapping
    @Operation(summary = &quot;Search students&quot;, description = &quot;Search and filter students with pagination&quot;)
    @ApiResponses(value = {
            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Students retrieved successfully&quot;,
                    content = @Content(schema = @Schema(implementation = StudentPageResponse.class)))
    })
    public ResponseEntity&lt;StudentPageResponse&gt; searchStudents(
            @Parameter(description = &quot;Filter by status (ACTIVE/INACTIVE)&quot;)
            @RequestParam(required = false) StudentStatus status,
            @Parameter(description = &quot;Filter by last name (starts with)&quot;)
            @RequestParam(required = false) String lastName,
            @Parameter(description = &quot;Page number (0-indexed)&quot;)
            @RequestParam(defaultValue = &quot;0&quot;) int page,
            @Parameter(description = &quot;Page size (max 100)&quot;)
            @RequestParam(defaultValue = &quot;20&quot;) int size,
            @Parameter(description = &quot;Sort field and direction (e.g., createdAt,desc)&quot;)
            @RequestParam(defaultValue = &quot;createdAt,desc&quot;) String sort) {

<span class="nc" id="L177">        log.info(&quot;Searching students: status={}, lastName={}, page={}, size={}&quot;, status, lastName, page, size);</span>

        // Validate page size
<span class="nc bnc" id="L180" title="All 2 branches missed.">        if (size &gt; 100) {</span>
<span class="nc" id="L181">            size = 100;</span>
        }

        // Parse sort
<span class="nc" id="L185">        String[] sortParams = sort.split(&quot;,&quot;);</span>
<span class="nc" id="L186">        String sortField = sortParams[0];</span>
<span class="nc bnc" id="L187" title="All 4 branches missed.">        Sort.Direction direction = sortParams.length &gt; 1 &amp;&amp; sortParams[1].equalsIgnoreCase(&quot;asc&quot;)</span>
<span class="nc" id="L188">                ? Sort.Direction.ASC</span>
<span class="nc" id="L189">                : Sort.Direction.DESC;</span>

<span class="nc" id="L191">        Pageable pageable = PageRequest.of(page, size, Sort.by(direction, sortField));</span>

        Page&lt;StudentDTO&gt; studentPage;

        // Apply filters
<span class="nc bnc" id="L196" title="All 2 branches missed.">        if (status != null) {</span>
<span class="nc" id="L197">            studentPage = searchService.findByStatus(status, pageable);</span>
<span class="nc bnc" id="L198" title="All 4 branches missed.">        } else if (lastName != null &amp;&amp; !lastName.isBlank()) {</span>
<span class="nc" id="L199">            studentPage = searchService.findByLastName(lastName, pageable);</span>
        } else {
<span class="nc" id="L201">            studentPage = searchService.findAll(pageable);</span>
        }

        // Build response
<span class="nc" id="L205">        StudentPageResponse response = StudentPageResponse.builder()</span>
<span class="nc" id="L206">                .content(studentPage.getContent())</span>
<span class="nc" id="L207">                .page(studentPage.getNumber())</span>
<span class="nc" id="L208">                .size(studentPage.getSize())</span>
<span class="nc" id="L209">                .totalElements(studentPage.getTotalElements())</span>
<span class="nc" id="L210">                .totalPages(studentPage.getTotalPages())</span>
<span class="nc" id="L211">                .first(studentPage.isFirst())</span>
<span class="nc" id="L212">                .last(studentPage.isLast())</span>
<span class="nc" id="L213">                .build();</span>

<span class="nc" id="L215">        return ResponseEntity.ok(response);</span>
    }

    /**
     * Updates student status.
     *
     * @param studentId the student ID
     * @param request the status update request
     * @param userId the user ID from header
     * @return updated student DTO
     */
    @PatchMapping(&quot;/{studentId}/status&quot;)
    @Operation(summary = &quot;Update student status&quot;, description = &quot;Activate or deactivate a student&quot;)
    @ApiResponses(value = {
            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Status updated successfully&quot;,
                    content = @Content(schema = @Schema(implementation = StudentDTO.class))),
            @ApiResponse(responseCode = &quot;404&quot;, description = &quot;Student not found&quot;,
                    content = @Content(schema = @Schema(implementation = ProblemDetail.class)))
    })
    public ResponseEntity&lt;StudentDTO&gt; updateStatus(
            @Parameter(description = &quot;Student ID&quot;)
            @PathVariable String studentId,
            @Valid @RequestBody UpdateStatusRequest request,
            @RequestHeader(value = &quot;X-User-ID&quot;, defaultValue = &quot;SYSTEM&quot;) String userId) {

<span class="nc" id="L240">        log.info(&quot;Updating student status: {} to {}&quot;, studentId, request.getStatus());</span>
<span class="nc" id="L241">        StudentDTO student = statusService.updateStatus(studentId, request.getStatus(), userId);</span>
<span class="nc" id="L242">        return ResponseEntity.ok(student);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>